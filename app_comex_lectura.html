<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Comercio Exterior ‚Äì Gesti√≥n de Embarques</title>
  <style>
    :root{
      --win-bg:#ECE9D8;
      --win-panel:#F3F3F3;
      --win-border:#9E9E9E;
      --win-border-dark:#7A7A7A;
      --win-text:#111;
      --win-muted:#666;
      --win-blue:#0A246A;
      --row-alt:#FAFAFA;
      --closed-bg:#F0F0F0;
      --closed-text:#777;
      --shadow: 0 1px 0 rgba(255,255,255,.8) inset, 0 1px 2px rgba(0,0,0,.15);
    }
    *{box-sizing:border-box}
    html, body{height:100%; margin:0;}
    body{
      font-size:12px;
      font-family: Tahoma, Segoe UI, Verdana, Arial, sans-serif;
      background: linear-gradient(#FFFFFF, var(--win-bg));
      color:var(--win-text);
      overflow:hidden; /* no scroll en la p√°gina, solo dentro de paneles */
    }

    .app{
      width:100vw;
      height:100vh;
      display:flex;
      flex-direction:column;
      padding:6px;
      gap:0;
    }

    .titlebar{
      background: linear-gradient(#1D4FA3, var(--win-blue));
      color:#fff;
      border:1px solid #001B4A;
      border-bottom:none;
      border-radius:10px 10px 0 0;
      padding:10px 12px;
      display:flex;
      align-items:center;
      gap:10px;
      box-shadow: var(--shadow);
      flex:0 0 auto;
    }
    .titlebar .icon{
      width:18px;height:18px;
      background:#fff;
      border-radius:3px;
      position:relative;
      flex:0 0 auto;
    }
    .titlebar .icon:before{
      content:"";
      position:absolute; inset:3px;
      border:2px solid #1D4FA3;
      border-top-color:#55A0FF;
      border-left-color:#55A0FF;
    }
    .titlebar h1{font-size:14px; margin:0; font-weight:700;}

    .window{
      flex:1 1 auto;
      min-height:0; /* clave para que el scroll interno funcione */
      border:1px solid var(--win-border-dark);
      border-radius:0 0 10px 10px;
      background: var(--win-panel);
      box-shadow: var(--shadow);
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }

    .tabs{
      display:flex;
      gap:4px;
      padding:8px 8px 0;
      background: var(--win-panel);
      border-bottom:1px solid var(--win-border);
      flex:0 0 auto;
    }
    .tab{
      appearance:none;
      border:1px solid var(--win-border);
      border-bottom:none;
      background: linear-gradient(#FFFFFF, #E6E6E6);
      padding:8px 10px;
      border-radius:6px 6px 0 0;
      cursor:pointer;
      font-size:12px;
      box-shadow: 0 1px 0 rgba(255,255,255,.8) inset;
    }
    .tab[aria-selected="true"]{
      background: linear-gradient(#FFFFFF, #F9F9F9);
      font-weight:700;
      position:relative;
      top:1px;
    }

    .content{
      flex:1 1 auto;
      padding:10px;
      min-height:0;
      padding:12px;
      background:#F9F9F9;
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }

    /* Cada panel usa el 100% del √°rea y scrollea internamente si hace falta */
    section[role="tabpanel"]{
      flex:1 1 auto;
      min-height:0;
      overflow-y:auto;
      overflow-x:hidden; /* sin barras */
    }
    .hidden{display:none !important}

    /* Form */
    .form-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:8px;
      align-items:start;
    }
    .group{
      border:1px solid var(--win-border);
      background:#fff;
      border-radius:10px;
      padding:8px;
      box-shadow: 0 1px 0 rgba(255,255,255,.8) inset;
    }
    .group h2{margin:0 0 8px; font-size:12px; color:var(--win-blue);}
    .fields{
      display:grid;
      grid-template-columns: 150px 1fr;
      gap:6px 8px;
      align-items:center;
    }
    label{font-size:11px; color:#222; user-select:none;}
    input, select, textarea{
      font-family: inherit;
      font-size:11px;
      padding:5px 7px;
      border:1px solid var(--win-border);
      border-radius:4px;
      background:#fff;
      outline:none;
      width:100%;
    }
    input:focus, select:focus, textarea:focus{
      border-color:#3D7BD9;
      box-shadow: 0 0 0 2px rgba(61,123,217,.18);
    }
    textarea{min-height:52px; resize:vertical}
    .form-actions{
      display:flex;
      justify-content:flex-end;
      margin-top:10px;
      gap:10px;
    }
    .btn{
      appearance:none;
      font-size:11px;
      border:1px solid var(--win-border-dark);
      background: linear-gradient(#FFFFFF, #DADADA);
      padding:6px 10px;
      border-radius:6px;
      cursor:pointer;
      font-size:12px;
      box-shadow: var(--shadow);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .btn:active{transform: translateY(1px)}
    .btn.primary{
      border-color:#0A246A;
      background: linear-gradient(#EAF3FF, #BFD8FF);
    }
    .btn.danger{
      border-color:#8B1A1A;
      background: linear-gradient(#FFECEC, #FFC7C7);
    }
    .hint{font-size:10px; color:var(--win-muted); margin-top:8px;}

    /* Toolbar + tables */
    .toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      justify-content:space-between;
      align-items:center;
      margin-bottom:10px;
    }
    .toolbar .left, .toolbar .right{display:flex; gap:8px; align-items:center}
    .search{display:flex; gap:6px; align-items:center;}
    .search input{width:min(360px, 46vw); font-size:11px; padding:5px 7px;}

    /* Table area takes remaining height */
    .table-area{
      flex:1 1 auto;
      min-height:0;
      overflow-y:auto;
      overflow-x:hidden;
      border-radius:10px;
    }

    table{
      width:100%;
      table-layout:fixed;
    }
    /* Columnas espec√≠ficas */
    th.notes-col, td.notes-col{
      width:42px;
      min-width:42px;
      max-width:42px;
      text-align:center;
    }
    th.t-col, td.t-col{
      width:34px;
      min-width:34px;
      max-width:34px;
      text-align:center;
    }
    th.estado-col, td.estado-col{
      width:110px;
      min-width:110px;
      max-width:110px;
    }

      border-collapse:separate;
      border-spacing:0;
      background:#fff;
      border:1px solid var(--win-border);
      border-radius:10px;
      overflow:hidden;
      box-shadow: 0 1px 0 rgba(255,255,255,.8) inset;
    }
    thead th{
      text-align:left;
      border-bottom:2px solid #000;
      font-size:10px;
      padding:8px;
      border-bottom:1px solid var(--win-border);
      background: linear-gradient(#FFFFFF, #EDEDED);
      position:sticky;
      top:0;
      z-index:1;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    tbody td{
      font-size:10px;
      padding:6px;
      border-bottom:1px solid #eee;
      vertical-align:top;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    tbody tr:nth-child(even){background:var(--row-alt)}
    tbody tr.closed{
      background: var(--closed-bg) !important;
      color: var(--closed-text);
    }
    tbody tr.closed a, tbody tr.closed button{opacity:.7}

    .mini{font-size:11px;color:var(--win-muted)}
    .link{color:#003399; text-decoration:underline; cursor:pointer;}

    /* Status pill */
    .pill{
      display:inline-flex;
      align-items:center;
      padding:2px 8px;
      white-space:nowrap;

      border-radius:999px;
      border:1px solid var(--win-border);
      font-size:11px;
      font-weight:700;
      text-transform:capitalize;
      background:#eee;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .pill.pendiente{background:#E6E6E6}
    .pill.encamino{background:#FFF2B3}
    .pill.recibido{background:#CFEFD3}
    .pill.cerrado{background:#E8E8E8; color:#666}

    /* Notes bubble tooltip */
    .note-bubble{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:20px;height:20px;
      border-radius:4px;
      border:1px solid var(--win-border);
      background: linear-gradient(#FFFFFF,#EFEFEF);
      box-shadow: 0 1px 0 rgba(255,255,255,.8) inset;
      cursor:default;
      position:relative;
    }
    .note-bubble:hover .tooltip{display:block}
    .tooltip{
      display:none;
      position:absolute;
      left:26px;
      top:0;
      min-width:260px;
      max-width:520px;

      white-space:normal;
      background:#FFFFE1;
      border:1px solid #B5B5B5;
      padding:8px;
      border-radius:6px;
      box-shadow: 0 2px 8px rgba(0,0,0,.18);
      z-index:10;
    }
    .tooltip:before{
      content:"";
      position:absolute;
      left:-6px;
      top:10px;
      width:10px;height:10px;
      background:#FFFFE1;
      border-left:1px solid #B5B5B5;
      border-top:1px solid #B5B5B5;
      transform: rotate(-45deg);
    }

    /* Cashflow cards */
    .cards{
      display:flex;
      gap:10px;
      overflow:auto;
      padding-bottom:6px;
      margin-bottom:12px;
      flex:0 0 auto;
    }
    .card{
      min-width:190px;
      border:1px solid var(--win-border);
      border-radius:10px;
      background:#fff;
      padding:10px;
      box-shadow: var(--shadow);
    }
    .card .date{
      font-size:11px;
      font-weight:700;
      color:var(--win-blue);
      margin-bottom:6px;
      text-transform:capitalize;
    }
    .card .line{
      display:flex;
      justify-content:space-between;
      gap:8px;
      font-size:11px;
      padding:3px 0;
      border-top:1px dotted #ddd;
    }
    .card .line:first-of-type{border-top:none}
    .badge{
      font-size:10px;
      padding:2px 6px;
      border-radius:10px;
      border:1px solid var(--win-border);
      background:#f2f2f2;
      color:#333;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    
    /* Tooltip tipo Excel (fixed para que no lo recorten contenedores) */
    .note-tooltip-fixed{
      position:fixed;
      display:none;
      min-width:260px;
      max-width:560px;
      background:#FFFFE1;
      border:1px solid #B5B5B5;
      padding:8px 10px;
      border-radius:6px;
      box-shadow: 0 2px 10px rgba(0,0,0,.22);
      z-index:99999;
      white-space:normal;
      color:#111;
      line-height:1.25;
      font-size:11px;
    }
    .note-tooltip-fixed:before{
      content:"";
      position:absolute;
      left:-6px;
      top:12px;
      width:10px;height:10px;
      background:#FFFFE1;
      border-left:1px solid #B5B5B5;
      border-top:1px solid #B5B5B5;
      transform: rotate(-45deg);
    }

    /* Fecha saldo vencida */
    .past-due{
      color:#8B0000 !important;
      font-weight:400;
      background:#FFEAEA;
    }

@media (max-width: 980px){
      .form-grid{grid-template-columns:1fr}
      .fields{grid-template-columns: 150px 1fr}
    }
  
    /* Gesti√≥n de Embarques: centrar contenido de todas las filas */
    #tableGest th,
    #tableGest td{
      text-align:center;
      vertical-align:middle;
    }


    /* Plan de Pagos: centrar contenido de todas las filas */
    #tablePagos th,
    #tablePagos td{
      text-align:center;
      vertical-align:middle;
    }


    /* Input + tilde (check) a la derecha */
    .input-check{
      display:flex;
      align-items:center;
      gap:6px;
    }
    .input-check input[type="checkbox"]{
      width:16px;
      height:16px;
      accent-color:#1b5e20; /* verde oscuro */
      flex:0 0 auto;
    }

    /* Monto pagado en planilla */
    .paid-amount{
      color:#1b5e20 !important; /* verde oscuro */
      font-weight:700;
    }


    /* Celda modificada recientemente (7 d√≠as) */
    .recent-change{
      background:#FFF3A0 !important;
    }


    .titlebar{
      position:relative;
    }
    .last-update{
      position:absolute;
      right:14px;
      top:50%;
      transform:translateY(-50%);
      color:#EAF2FF;
      font-size:12px;
      white-space:nowrap;
      opacity:.95;
    }
    .last-update .mini{ color:#D6E6FF; margin-right:6px; }


/* Ajuste ancho columna Carga en Gesti√≥n de Embarques */
#tableGest th:nth-child(5),
#tableGest td:nth-child(5){
  max-width:60px;
  width:60px;
  white-space:nowrap;
}


/* Ajuste columna Acciones para que se lean Editar y Borrar */
#tableGest th:last-child,
#tableGest td:last-child{
  min-width:140px;
  width:140px;
  white-space:nowrap;
}

#tableGest td:last-child button{
  margin:2px 4px;
}


/* ---------- Login ---------- */
.login-overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.45);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
}
.login-overlay.show{ display:flex; }
.login-card{
  width:min(420px, 92vw);
  background:#fff;
  border-radius:16px;
  box-shadow:0 18px 50px rgba(0,0,0,.35);
  padding:18px 18px 14px 18px;
  border:1px solid rgba(10,36,106,.15);
}
.login-title{
  font-size:18px;
  font-weight:800;
  color:#0A246A;
  margin-bottom:4px;
}
.login-sub{
  font-size:12px;
  color:#334;
  opacity:.8;
  margin-bottom:12px;
}
.login-fields{
  display:grid;
  grid-template-columns: 110px 1fr;
  gap:10px 10px;
  align-items:center;
}
.login-fields label{
  font-size:12px;
  font-weight:700;
  color:#0A246A;
}
.login-fields input{
  padding:10px 10px;
  border-radius:10px;
  border:1px solid rgba(0,0,0,.25);
  outline:none;
}
.login-actions{
  margin-top:14px;
  display:flex;
  justify-content:flex-end;
}
.login-hint{
  margin-top:10px;
  font-size:12px;
  color:#8B0000;
  min-height:16px;
}
.userbox{
  position:absolute;
  right:190px; /* deja lugar para √ölt. actualizaci√≥n */
  top:50%;
  transform:translateY(-50%);
  color:#EAF2FF;
  font-size:12px;
  white-space:nowrap;
  opacity:.98;
}
.userbox .mini{ color:#D6E6FF; margin-right:6px; }

@media (max-width: 980px){
  .userbox{ right:14px; top:calc(50% + 18px); transform:translateY(-50%); }
  .last-update{ top:calc(50% - 18px); }
}


.users-overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:10000}
.users-overlay.show{display:flex}
.users-card{background:#fff;border-radius:12px;padding:16px;min-width:320px}
.users-form-grid{display:grid;grid-template-columns:120px 1fr;gap:8px}

</style>
</head>
<body>

  <!-- Login Overlay -->
  <div id="loginOverlay" class="login-overlay" aria-hidden="true">
    <div class="login-card" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
      <div class="login-title" id="loginTitle">Ingreso</div>
      <div class="login-sub">Comercio Exterior ‚Äì Acceso por usuario</div>
      <div class="login-fields">
        <label for="loginUser">Usuario</label>
        <input id="loginUser" autocomplete="username" placeholder="usuario" />
        <label for="loginPass">Contrase√±a</label>
        <input id="loginPass" type="password" autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
      </div>
      <div class="login-actions">
        <button class="btn" id="btnLogin" type="button">Entrar</button>
      </div>
      <div class="login-hint" id="loginHint"></div>
    </div>
  </div>

  <div class="app">
    <div class="titlebar">
      <div class="icon" aria-hidden="true"></div>
      <h1>Comercio Exterior ‚Äì Gesti√≥n de Embarques &amp; Plan de Pagos</h1>
        <div class="last-update" id="lastUpdateWrap" title="√öltima actualizaci√≥n (creaci√≥n/edici√≥n)"><span class="mini">√ölt. actualizaci√≥n:</span> <span id="lastUpdateLabel">‚Äî</span></div>

        <div class="userbox" id="userBox" style="display:none">
          <span class="mini">Usuario:</span> <b id="userLabel">‚Äî</b>
          <button class="btn" id="btnLogout" type="button" style="margin-left:10px; padding:6px 10px;">Salir</button>
        </div>

    </div>

    <div class="window">
      <div class="tabs" role="tablist" aria-label="Solapas">
        <button class="tab" role="tab" id="tab-form" aria-selected="true" aria-controls="panel-form">Formulario</button>
        <button class="tab" role="tab" id="tab-gest" aria-selected="false" aria-controls="panel-gest">Gesti√≥n de Embarques</button>
        <button class="tab" role="tab" id="tab-pagos" aria-selected="false" aria-controls="panel-pagos">Plan de Pagos</button>
      </div>

      <div class="content">
        <!-- Formulario -->
        <section id="panel-form" role="tabpanel" aria-labelledby="tab-form">
          <div class="form-grid">
            <div class="group">
              <h2>Datos del embarque</h2>
              <div class="fields">
                <label for="estado">Estado</label>
                <select id="estado">
                  <option value="Pendiente">Pendiente</option>
                  <option value="En Camino">En Camino</option>
                  <option value="Recibido">Recibido</option>
                  <option value="Cerrado">Cerrado</option>
                </select>

                <label for="nroEmbarque">Nro de Embarque</label>
                <input id="nroEmbarque" placeholder="Ej: M1230" />

                <label for="importador">Importador</label>
                <select id="importador">
                  <option value="Servitools">Servitools</option>
                  <option value="SIA Log√≠stica">SIA Log√≠stica</option>
                  <option value="SIA">SIA</option>
                </select>

                <label for="proveedor">Proveedor</label>
                <input id="proveedor" placeholder="Texto" />

                <label for="tflag">T</label>
                <select id="tflag">
                  <option value="No">No</option>
                  <option value="Si">Si</option>
                </select>

                <label for="tipoCarga">Tipo de carga</label>
                <select id="tipoCarga">
                  <option value="LCL">LCL</option>
                  <option value="20">20</option>
                  <option value="40">40</option>
                  <option value="40HQ">40HQ</option>
                  <option value="Courrier">Courrier</option>
                </select>

                <label for="nroContenedor">Nro Contenedor</label>
                <input id="nroContenedor" placeholder="Texto/Num" />

                <label for="agencia">Agencia</label>
                <input id="agencia" placeholder="Texto/Num" />

                <label for="etd">ETD (Fecha embarque)</label>
                <input id="etd" type="date" />

                <label for="eta">ETA (Fecha llegada)</label>
                <input id="eta" type="date" />

                <label for="puerto">Puerto (origen)</label>
                <input id="puerto" placeholder="Ej: Ningbo" />

                <label for="terminal">Terminal</label>
                <input id="terminal" placeholder="Texto/Num" />

                <label for="deposito">Dep√≥sito</label>
                <select id="deposito">
                  <option value="San Martin">San Martin</option>
                  <option value="La Reja">La Reja</option>
                </select>

                <label for="notas">Notas</label>
                <textarea id="notas" placeholder="Observaciones del embarque‚Ä¶"></textarea>

                <label for="documentos">Doc. Embarque (URL)</label>
                <input id="documentos" placeholder="https://‚Ä¶" />
</div>
            </div>

            <div class="group">
              <h2>Condici√≥n de pago</h2>
              <div class="fields">
                <label for="condPago">Condici√≥n de pago</label>
                <input id="condPago" placeholder="Ej: 30% anticipo / 70% saldo" />

                <label for="moneda">Moneda</label>
                <select id="moneda">
                  <option value="USD">USD</option>
                  <option value="Yuanes">Yuanes</option>
                  <option value="Reales">Reales</option>
                </select>

                <label for="factura">Factura</label>
                <input id="factura" inputmode="decimal" placeholder="0,00" />

                <label for="fechaAnticipo">Fecha anticipo</label>
                <input id="fechaAnticipo" type="date" />

                <label for="anticipo">Anticipo</label>
                <div class="input-check">
                  <input id="anticipo" inputmode="decimal" placeholder="0,00" />
                  <input type="checkbox" id="chkAnticipo" title="Pago realizado" aria-label="Pago realizado" />
                </div>

                <label for="fechaSaldo">Fecha saldo</label>
                <input id="fechaSaldo" type="date" />


                <label for="saldo">Saldo</label>
                <div class="input-check">
                  <input id="saldo" inputmode="decimal" placeholder="0,00" />
                  <input type="checkbox" id="chkSaldo" title="Pago realizado" aria-label="Pago realizado" />
                </div>

                <label for="fechaAgencia">Fecha Agencia</label>
                <input id="fechaAgencia" type="date" />

                <label for="saldoAgencia">Monto Agencia</label>
                <div class="input-check">
                  <input id="saldoAgencia" inputmode="decimal" placeholder="0,00" />
                  <input type="checkbox" id="chkAgencia" title="Pago realizado" aria-label="Pago realizado" />
                </div>

                <label for="fechaDespacho">Fecha Despacho</label>
                <input id="fechaDespacho" type="date" />

                <label for="pagoDespacho">Monto Despacho</label>
                <div class="input-check">
                  <input id="pagoDespacho" inputmode="decimal" placeholder="0,00" />
                  <input type="checkbox" id="chkDespacho" title="Pago realizado" aria-label="Pago realizado" />
                </div>

                <label for="docFacturacion">Doc. Facturaci√≥n (URL)</label>
                <input id="docFacturacion" placeholder="https://‚Ä¶" />
</div>

              <div class="form-actions">
                <button class="btn" id="btnReset" type="button">Limpiar</button>
                <button class="btn primary" id="btnSubmit" type="button">Generar Embarque</button>
              </div>

              <div class="hint">
                Esta versi√≥n guarda los datos en el navegador (localStorage). Pr√≥ximo paso: conexi√≥n a Google Sheets (Apps Script / Web App).
              </div>
            </div>
          </div>
        </section>

        <!-- Gesti√≥n de Embarques -->
        <section id="panel-gest" role="tabpanel" aria-labelledby="tab-gest" class="hidden">
          <div class="toolbar">
            <div class="left">
              <span class="badge">Orden: ETA ascendente (Cerrados al final)</span>
            </div>
            <div class="right">
              <div class="search">
                <span class="mini">Buscar</span>
                <input id="searchGest" placeholder="Nro, proveedor, importador, puerto‚Ä¶" />
              </div>
              <button class="btn" id="btnExportGest" type="button">Exportar CSV</button>
            </div>
          </div>

          <div class="table-area">
            <table id="tableGest">
              <thead>
                <tr>
                  <th>Nro Embarque</th>
                  <th>Importador</th>
                  <th>Proveedor</th>
                  <th class="t-col">T</th>
                  <th>Carga</th>
                  <th>Nro Contenedor</th>
                  
                  
                  <th>ETD</th>
                  <th>ETA</th>
                  <th class="notes-col">Notas</th>
                  <th>Puerto</th>
                  <th>Terminal</th>
                  <th>Dep√≥sito</th>
                  
                  
                  
                  <th class="estado-col">Estado</th>
                  
                  <th>Doc. Embarque</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </section>

        <!-- Plan de Pagos -->
        <section id="panel-pagos" role="tabpanel" aria-labelledby="tab-pagos" class="hidden">
          <div style="font-size:12px;font-weight:700;margin:0 0 6px 2px;color:#0A246A;">Cash Flow</div>
          <div class="cards" id="cashflowCards" aria-label="Cashflow por fecha de saldo"></div>

          <div class="toolbar">
            <div class="left">
              <span class="badge">Solo embarques no cerrados</span>
            </div>
            <div class="right">
              <div class="search">
                <span class="mini">Buscar</span>
                <input id="searchPagos" placeholder="Nro, proveedor, importador‚Ä¶" />
              </div>
              <button class="btn" id="btnExportPagos" type="button">Exportar CSV</button>
            </div>
          </div>

          <div class="table-area">
            <table id="tablePagos">
              <thead>
                <tr>
                  <th>Nro Embarque</th>
                  <th class="estado-col">Estado</th>
                  <th>Importador</th>
                  <th>Proveedor</th>
                  <th class="t-col">T</th>
                  <th class="notes-col">Notas</th>
                  <th>Condici√≥n de Pago</th>
                  
                  <th>ETA</th>
                  
                  
                  
                  
                  <th>Moneda</th>
                  <th>Factura</th>
                  <th>Fecha Anticipo</th>
                  <th>Anticipo</th>
                  <th>Fecha Saldo</th>
                  <th>Saldo</th>
                  <th>Fecha Agencia</th>
                  <th>Monto Agencia</th>
                  <th>Fecha Despacho</th>
                  <th>Monto Despacho</th>
                  <th>Doc. Facturaci√≥n</th>
                                    
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </section>
      </div>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
  // ---------- Utilidades ----------
  const fmtMoney = new Intl.NumberFormat('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  const nowIso = () => new Date().toISOString();
  const fmtDateTimeAR = (iso) => {
    if(!iso) return '';
    const d = new Date(iso);
    if(Number.isNaN(d.getTime())) return '';
    const dd = String(d.getDate()).padStart(2,'0');
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const yy = d.getFullYear();
    const hh = String(d.getHours()).padStart(2,'0');
    const mi = String(d.getMinutes()).padStart(2,'0');
    return `${dd}/${mm}/${yy} ${hh}:${mi}`;
  };
  const isWithinDays = (iso, days) => {
    if(!iso) return false;
    const d = new Date(iso);
    if(Number.isNaN(d.getTime())) return false;
    const ms = days * 24 * 60 * 60 * 1000;
    return (Date.now() - d.getTime()) <= ms;
  };

  const fmtDateAR = (iso) => {
    if(!iso) return "";
    const d = new Date(iso + "T00:00:00");
    if(Number.isNaN(d.getTime())) return "";
    const dd = String(d.getDate()).padStart(2,'0');
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const yy = d.getFullYear();
    return `${dd}/${mm}/${yy}`;
  };
  const monthKey = (iso) => {
    if(!iso) return null;
    const d = new Date(iso + "T00:00:00");
    if(Number.isNaN(d.getTime())) return null;
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
  };
  const monthLabelAR = (key) => {
    const [y,m] = key.split('-').map(Number);
    const d = new Date(y, m-1, 1);
    return d.toLocaleDateString('es-AR', { month:'long', year:'numeric' });
  };
  const toNumberAR = (s) => {
    if(s === null || s === undefined) return 0;
    if(typeof s === 'number') return s;
    const t = String(s).trim();
    if(!t) return 0;
    const normalized = t.replace(/\s/g,'').replace(/\./g,'').replace(',', '.');
    const n = Number(normalized);
    return Number.isFinite(n) ? n : 0;
  };
  const isPastDue = (iso) => {
    if(!iso) return false;
    const d = new Date(iso + 'T00:00:00');
    if(Number.isNaN(d.getTime())) return false;
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    return d.getTime() < today.getTime();
  };

  const statusClass = (estado) => {
    const e = (estado||"").toLowerCase().replace(/\s+/g,'');
    if(e === 'pendiente') return 'pendiente';
    if(e === 'encamino') return 'encamino';
    if(e === 'recibido') return 'recibido';
    if(e === 'cerrado') return 'cerrado';
    return 'pendiente';
  };

  // ---------- Estado global ----------
  const READ_ONLY = true;
  const CSV_SOURCE_FILE = 'gestion_embarques.csv';

  const STORAGE_KEY = 'sia_embarques_v1';
  let data = [];
  let editingId = null;

  function normalizeRecords(){
    const now = nowIso();
    for(const r of data){
      if(!r.updatedAt) r.updatedAt = now;
      if(!r.changes) r.changes = {};
    }
  }

  async function loadData(){
    if(READ_ONLY){
      const mergeByNro = (a,b)=>{
        const out = {...a, ...b};
        out.nroEmbarque = (out.nroEmbarque||'').toString().trim();
        out.updatedAt = nowIso();
        out.changes = {};
        return out;
      };

      const mapGest = (r)=>({
        id: crypto.randomUUID(),
        estado: r["Estado"] || '',
        nroEmbarque: (r["Nro Embarque"] || '').toString().trim(),
        importador: r["Importador"] || '',
        proveedor: r["Proveedor"] || '',
        tflag: r["T"] || 'No',
        tipoCarga: r["Carga"] || '',
        nroContenedor: r["Nro Contenedor"] || '',
        etd: (r["ETD"] && toIsoFromAR(r["ETD"])) || '',
        eta: (r["ETA"] && toIsoFromAR(r["ETA"])) || '',
        notas: r["Notas"] || '',
        puerto: r["Puerto"] || '',
        terminal: r["Terminal"] || '',
        deposito: r["Dep√≥sito"] || '',
        docFacturacion: r["Doc"] || '',
        documentos: r["Documentos"] || '',
      });

      const mapPagos = (r)=>({
        // mismo nro como clave
        estado: r["Estado"] || '',
        nroEmbarque: (r["Nro Embarque"] || '').toString().trim(),
        importador: r["Importador"] || '',
        proveedor: r["Proveedor"] || '',
        tflag: r["T"] || 'No',
        notas: r["Notas"] || '',
        condPago: r["Condici√≥n de Pago"] || '',
        eta: (r["ETA"] && toIsoFromAR(r["ETA"])) || '',
        puerto: r["Puerto"] || '',
        terminal: r["Terminal"] || '',
        deposito: r["Dep√≥sito"] || '',
        moneda: r["Moneda"] || 'USD',
        factura: toNumberAR(r["Factura"] || ''),
        fechaAnticipo: (r["Fecha Anticipo"] && toIsoFromAR(r["Fecha Anticipo"])) || '',
        anticipo: toNumberAR(r["Anticipo"] || ''),
        chkAnticipo: !!toNumberAR(r["Anticipo"] || ''),
        fechaSaldo: (r["Fecha Saldo"] && toIsoFromAR(r["Fecha Saldo"])) || '',
        saldo: toNumberAR(r["Saldo"] || ''),
        chkSaldo: !!toNumberAR(r["Saldo"] || ''),
        fechaAgencia: (r["Fecha Agencia"] && toIsoFromAR(r["Fecha Agencia"])) || '',
        saldoAgencia: toNumberAR(r["Monto Agencia"] || ''),
        chkAgencia: !!toNumberAR(r["Monto Agencia"] || ''),
        fechaDespacho: (r["Fecha Despacho"] && toIsoFromAR(r["Fecha Despacho"])) || '',
        pagoDespacho: toNumberAR(r["Monto Despacho"] || ''),
        chkDespacho: !!toNumberAR(r["Monto Despacho"] || ''),
        docFacturacion: r["Doc. Facturaci√≥n"] || r["Doc"] || '',
      });

      try{
        // Intentar leer ambos. Si falta uno, igual seguimos con el que exista.
        const results = await Promise.allSettled([
          fetch(CSV_SOURCE_FILE, { cache: 'no-store' }).then(r=>r.ok ? r.text() : Promise.reject(new Error(`No se pudo leer ${CSV_SOURCE_FILE} (HTTP ${r.status})`))),
          fetch('plan_de_pagos.csv', { cache: 'no-store' }).then(r=>r.ok ? r.text() : Promise.reject(new Error(`No se pudo leer plan_de_pagos.csv (HTTP ${r.status})`))),
        ]);

        let gestRows = [];
        let pagosRows = [];

        if(results[0].status === 'fulfilled'){
          const parsed = Papa.parse(results[0].value, { header:true, skipEmptyLines:true });
          gestRows = (parsed.data||[]).filter(r => Object.values(r||{}).some(v => String(v||'').trim() !== ''))
            .map(mapGest);
        }

        if(results[1].status === 'fulfilled'){
          const parsed = Papa.parse(results[1].value, { header:true, skipEmptyLines:true });
          pagosRows = (parsed.data||[]).filter(r => Object.values(r||{}).some(v => String(v||'').trim() !== ''))
            .map(mapPagos);
        }

        const byNro = new Map();
        for(const r of gestRows){ if(r.nroEmbarque) byNro.set(r.nroEmbarque, r); }
        for(const r of pagosRows){
          if(!r.nroEmbarque) continue;
          const prev = byNro.get(r.nroEmbarque);
          byNro.set(r.nroEmbarque, prev ? mergeByNro(prev, r) : mergeByNro({id: crypto.randomUUID()}, r));
        }

        data = Array.from(byNro.values());

        normalizeRecords();
      }catch(e){
        console.warn(e);
        data = [];
      }
      return;
    }

    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      data = raw ? JSON.parse(raw) : [];
      if(!Array.isArray(data)) data = [];
      normalizeRecords();
    }catch(e){
      data = [];
    }
  }

      return;
    }
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      data = raw ? JSON.parse(raw) : [];
      if(!Array.isArray(data)) data = [];
      normalizeRecords();
    }catch(e){
      data = [];
    }
  }catch(e){ data = []; }
  }
  function saveData(){
    if(READ_ONLY) return;
    try{
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }catch(e){
      console.warn('No se pudo guardar', e);
    }
  }

  // ---------- Tabs ----------
  const tabs = [
    { btn: document.getElementById('tab-form'), panel: document.getElementById('panel-form') },
    { btn: document.getElementById('tab-gest'), panel: document.getElementById('panel-gest') },
    { btn: document.getElementById('tab-pagos'), panel: document.getElementById('panel-pagos') },
  ];
  function activateTab(idx){
    tabs.forEach((t,i)=>{
      const sel = i===idx;
      t.btn.setAttribute('aria-selected', sel ? 'true' : 'false');
      t.panel.classList.toggle('hidden', !sel);
    });
  }
  tabs.forEach((t,i)=>t.btn.addEventListener('click', ()=>activateTab(i)));

  // ---------- Login / Permisos ----------
  // Nota: esto es un login "local" (front-end). Sirve para control b√°sico de UI en esta versi√≥n sin backend.
  // Edit√° usuarios/roles ac√°:
  const USERS = {
    // 3 solapas (admin / data entry)
    "admin": { pass:"admin$1234", tabs:["tab-form","tab-gest","tab-pagos"] },

    // 2 solapas (operaciones)
    "operaciones": { pass:"operaciones1234", tabs:["tab-gest","tab-pagos"] },

    // 1 solapa (solo Gesti√≥n)
    "consulta": { pass:"consulta1234", tabs:["tab-gest"] },
  };

  const AUTH_KEY = 'sia_embarques_auth_v1';

  function setAllowedTabs(allowedIds){
    // Ocultar/mostrar tabs + paneles seg√∫n permisos
    const allowed = new Set(allowedIds || []);
    tabs.forEach((t, i)=>{
      const ok = allowed.has(t.btn.id);
      t.btn.style.display = ok ? '' : 'none';
      t.panel.style.display = ok ? '' : 'none';
      if(!ok) t.panel.classList.add('hidden');
    });

    // Activar la primera solapa permitida
    const firstIdx = tabs.findIndex(t=>allowed.has(t.btn.id));
    activateTab(firstIdx >= 0 ? firstIdx : 0);
  }

  function showLogin(){
    const ov = document.getElementById('loginOverlay');
    if(!ov) return;
    ov.classList.add('show');
    ov.setAttribute('aria-hidden','false');
    document.getElementById('loginHint').textContent = '';
    const u = document.getElementById('loginUser');
    const p = document.getElementById('loginPass');
    if(u) u.value = '';
    if(p) p.value = '';
    setTimeout(()=>u && u.focus(), 50);
  }

  function hideLogin(){
    const ov = document.getElementById('loginOverlay');
    if(!ov) return;
    ov.classList.remove('show');
    ov.setAttribute('aria-hidden','true');
  }

  function setUserUI(username){
    const box = document.getElementById('userBox');
    const lab = document.getElementById('userLabel');
    if(box && lab){
      lab.textContent = username || '‚Äî';
      box.style.display = username ? '' : 'none';
    }
  }

  function logout(){
    try{ localStorage.removeItem(AUTH_KEY); }catch(e){}
    setUserUI('');
    showLogin();
    // por seguridad visual, ocultar todo hasta loguearse
    setAllowedTabs([]);
  }

  function tryRestoreAuth(){
    try{
      const raw = localStorage.getItem(AUTH_KEY);
      if(!raw) return false;
      const auth = JSON.parse(raw);
      if(!auth || !auth.user || !USERS[auth.user]) return false;
      setUserUI(auth.user);
      setAllowedTabs(USERS[auth.user].tabs);
      return true;
    }catch(e){
      return false;
    }
  }

  function doLogin(){
    const u = (document.getElementById('loginUser')?.value || '').trim();
    const p = (document.getElementById('loginPass')?.value || '').trim();
    const hint = document.getElementById('loginHint');

    if(!u || !p){
      if(hint) hint.textContent = 'Ingres√° usuario y contrase√±a.';
      return;
    }
    const cfg = USERS[u];
    if(!cfg || cfg.pass !== p){
      if(hint) hint.textContent = 'Usuario o contrase√±a inv√°lidos.';
      return;
    }
    try{ localStorage.setItem(AUTH_KEY, JSON.stringify({user:u, at: nowIso()})); }catch(e){}
    setUserUI(u);
    setAllowedTabs(cfg.tabs);
    hideLogin();
  }

  // Eventos login
  document.getElementById('btnLogin')?.addEventListener('click', doLogin);
  document.getElementById('btnLogout')?.addEventListener('click', logout);
  document.getElementById('loginPass')?.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') doLogin(); });
  document.getElementById('loginUser')?.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') document.getElementById('loginPass')?.focus(); });



  // ---------- Form bindings ----------
  const $ = (id)=>document.getElementById(id);
  const fields = {
    estado: $('estado'),
    nroEmbarque: $('nroEmbarque'),
    importador: $('importador'),
    proveedor: $('proveedor'),
    tflag: $('tflag'),
    tipoCarga: $('tipoCarga'),
    nroContenedor: $('nroContenedor'),
    agencia: $('agencia'),
    etd: $('etd'),
    eta: $('eta'),
    puerto: $('puerto'),
    terminal: $('terminal'),
    deposito: $('deposito'),
    condPago: $('condPago'),
    moneda: $('moneda'),
    factura: $('factura'),
    fechaAnticipo: $('fechaAnticipo'),
    anticipo: $('anticipo'),
    chkAnticipo: $('chkAnticipo'),
    fechaSaldo: $('fechaSaldo'),
    saldo: $('saldo'),
    chkSaldo: $('chkSaldo'),
    fechaAgencia: $('fechaAgencia'),
    saldoAgencia: $('saldoAgencia'),
    chkAgencia: $('chkAgencia'),
    fechaDespacho: $('fechaDespacho'),
    pagoDespacho: $('pagoDespacho'),
    chkDespacho: $('chkDespacho'),
    docFacturacion: $('docFacturacion'),
    notas: $('notas'),
    documentos: $('documentos'),
  };  ['factura','anticipo','saldo','saldoAgencia','pagoDespacho'].forEach(id=>{
    fields[id].addEventListener('blur', ()=>{
      const n = toNumberAR(fields[id].value);
      fields[id].value = fields[id].value.trim() ? fmtMoney.format(n) : '';
    });
  });

  function clearForm(){
    editingId = null;
    Object.values(fields).forEach(el=>{
      if(!el) return;
      if(el.type === 'checkbox') el.checked = false;
      else if(el.tagName === 'SELECT') el.selectedIndex = 0;
      else el.value = '';
    });
    $('btnSubmit').textContent = 'Generar Embarque';
  }
  $('btnReset').addEventListener('click', clearForm);

  function fillForm(rec){
    editingId = rec.id;
    fields.estado.value = rec.estado || 'Pendiente';
    fields.nroEmbarque.value = rec.nroEmbarque || '';
    fields.importador.value = rec.importador || 'Servitools';
    fields.proveedor.value = rec.proveedor || '';
    fields.tflag.value = rec.tflag || 'No';
    fields.tipoCarga.value = rec.tipoCarga || 'LCL';
    fields.nroContenedor.value = rec.nroContenedor || '';
    fields.agencia.value = rec.agencia || '';
    fields.etd.value = rec.etd || '';
    fields.eta.value = rec.eta || '';
    fields.puerto.value = rec.puerto || '';
    fields.terminal.value = rec.terminal || '';
    fields.deposito.value = rec.deposito || 'San Martin';
    fields.condPago.value = rec.condPago || '';
    fields.moneda.value = rec.moneda || 'USD';
    fields.factura.value = rec.factura != null ? fmtMoney.format(rec.factura) : '';
    fields.fechaAnticipo.value = rec.fechaAnticipo || '';
    fields.anticipo.value = rec.anticipo != null ? fmtMoney.format(rec.anticipo) : '';
    fields.chkAnticipo.checked = !!rec.chkAnticipo;
    fields.fechaSaldo.value = rec.fechaSaldo || '';
    fields.saldo.value = rec.saldo != null ? fmtMoney.format(rec.saldo) : '';
    fields.chkSaldo.checked = !!rec.chkSaldo;
    fields.fechaAgencia.value = rec.fechaAgencia || '';
    fields.saldoAgencia.value = rec.saldoAgencia != null ? fmtMoney.format(rec.saldoAgencia) : '';
    fields.chkAgencia.checked = !!rec.chkAgencia;
    fields.fechaDespacho.value = rec.fechaDespacho || '';
    fields.pagoDespacho.value = rec.pagoDespacho != null ? fmtMoney.format(rec.pagoDespacho) : '';
    fields.chkDespacho.checked = !!rec.chkDespacho;
    fields.docFacturacion.value = rec.docFacturacion || '';
    fields.notas.value = rec.notas || '';
    fields.documentos.value = rec.documentos || '';
    $('btnSubmit').textContent = 'Guardar cambios';
  }

  function upsertRecord(){
    const prev = editingId ? data.find(x=>x.id===editingId) : null;
    const now = nowIso();
    const prevChanges = (prev && prev.changes) ? prev.changes : {};
    const changes = {...prevChanges};

    const rec = {
      id: editingId || crypto.randomUUID(),
      estado: fields.estado.value,
      nroEmbarque: fields.nroEmbarque.value.trim(),
      importador: fields.importador.value,
      proveedor: fields.proveedor.value.trim(),
      tflag: fields.tflag.value,
      tipoCarga: fields.tipoCarga.value,
      nroContenedor: fields.nroContenedor.value.trim(),
      agencia: fields.agencia.value.trim(),
      etd: fields.etd.value || '',
      eta: fields.eta.value || '',
      puerto: fields.puerto.value.trim(),
      terminal: fields.terminal.value.trim(),
      deposito: fields.deposito.value,
      condPago: fields.condPago.value.trim(),
      moneda: fields.moneda.value,
      factura: toNumberAR(fields.factura.value),
      fechaAnticipo: fields.fechaAnticipo.value || '',
      anticipo: toNumberAR(fields.anticipo.value),
      chkAnticipo: !!fields.chkAnticipo.checked,
      fechaSaldo: fields.fechaSaldo.value || '',
      saldo: toNumberAR(fields.saldo.value),
      chkSaldo: !!fields.chkSaldo.checked,
      fechaAgencia: fields.fechaAgencia.value || '',
      saldoAgencia: toNumberAR(fields.saldoAgencia.value),
      chkAgencia: !!fields.chkAgencia.checked,
      fechaDespacho: fields.fechaDespacho.value || '',
      pagoDespacho: toNumberAR(fields.pagoDespacho.value),
      chkDespacho: !!fields.chkDespacho.checked,
      docFacturacion: fields.docFacturacion.value.trim(),
      updatedAt: now,
      changes: changes,
      notas: fields.notas.value.trim(),
      documentos: fields.documentos.value.trim(),
    };

    // Marcar campos modificados (queda amarillo 7 d√≠as)
    if(prev){
      const keys = Object.keys(rec).filter(k => !['id','updatedAt','changes'].includes(k));
      for(const k of keys){
        if(JSON.stringify(prev[k]) !== JSON.stringify(rec[k])){
          changes[k] = now;
        }
      }

      // Si cambia el tilde (pago realizado), tambi√©n marcar la celda del monto correspondiente
      if(JSON.stringify(prev.chkAnticipo) !== JSON.stringify(rec.chkAnticipo)) changes['anticipo'] = now;
      if(JSON.stringify(prev.chkSaldo) !== JSON.stringify(rec.chkSaldo)) changes['saldo'] = now;
      if(JSON.stringify(prev.chkAgencia) !== JSON.stringify(rec.chkAgencia)) changes['saldoAgencia'] = now;
      if(JSON.stringify(prev.chkDespacho) !== JSON.stringify(rec.chkDespacho)) changes['pagoDespacho'] = now;
    }

    const idx = data.findIndex(x=>x.id===rec.id);
    if(idx>=0) data[idx] = rec;
    else data.push(rec);
    saveData();
    renderAll();
    clearForm();
    activateTab(1);
  }

  $('btnSubmit').addEventListener('click', ()=>{
    if(!fields.nroEmbarque.value.trim()){
      alert('Por favor carg√° el Nro de Embarque.');
      fields.nroEmbarque.focus();
      return;
    }
    upsertRecord();
  });

  // ---------- Render ----------
  const gestBody = document.querySelector('#tableGest tbody');
  const pagosBody = document.querySelector('#tablePagos tbody');

  function sortedGestion(records){
    const open = records.filter(r => (r.estado||'').toLowerCase() !== 'cerrado');
    const closed = records.filter(r => (r.estado||'').toLowerCase() === 'cerrado');
    const byEta = (a,b)=>{
      const da = a.eta ? new Date(a.eta+"T00:00:00").getTime() : Number.POSITIVE_INFINITY;
      const db = b.eta ? new Date(b.eta+"T00:00:00").getTime() : Number.POSITIVE_INFINITY;
      if(da !== db) return da - db;
      return (a.nroEmbarque||'').localeCompare(b.nroEmbarque||'');
    };
    open.sort(byEta); closed.sort(byEta);
    return open.concat(closed);
  }

  function rowNoteCell(text){
    if(!text) return `<span class="mini">‚Äî</span>`;
    const safe = text.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
    return `<span class="note-bubble" data-note="${safe}">üí¨</span>`;
  }
  function docCell(url){
    if(!url) return `<span class="mini">‚Äî</span>`;
    const safe = url.replaceAll('"','&quot;');
    return `<a class="link" href="${safe}" target="_blank" rel="noopener">Abrir</a>`;
  }
  function applyTitles(tableEl){
    if(!tableEl) return;
    tableEl.querySelectorAll('th,td').forEach(cell=>{
      // Evitar tooltips en botones, links o globito de notas
      if(cell.classList.contains('notes-col')) return;
      if(cell.querySelector('button') || cell.querySelector('a') || cell.querySelector('.note-bubble')) return;
      const txt = (cell.textContent || '').trim();
      if(!txt) return;
      cell.title = txt;
    });
  }

  function estadoCell(estado){
    const cls = statusClass(estado);
    return `<span class="pill ${cls}">${(estado||'Pendiente')}</span>`;
  }

  function renderGestion(){
    const q = $('searchGest').value.trim().toLowerCase();
    const rows = sortedGestion(data).filter(r=>{
      if(!q) return true;
      const hay = [r.nroEmbarque,r.importador,r.proveedor,r.puerto,r.agencia,r.nroContenedor,r.terminal,r.deposito,r.estado].join(' ').toLowerCase();
      return hay.includes(q);
    });

    gestBody.innerHTML = rows.map(r=>{
      const closed = (r.estado||'').toLowerCase() === 'cerrado';
      return `
        <tr class="${closed ? 'closed' : ''}">
          <td class="${changedClass(r,'nroEmbarque')}">${r.nroEmbarque || ''}</td>
          <td class="${changedClass(r,'importador')}">${r.importador || ''}</td>
          <td class="${changedClass(r,'proveedor')}">${r.proveedor || ''}</td>
          <td class="${changedClass(r,'tflag')} t-col">${r.tflag || ''}</td>
          <td class="${changedClass(r,'tipoCarga')}">${r.tipoCarga || ''}</td>
          <td class="${changedClass(r,'nroContenedor')}">${r.nroContenedor || ''}</td>
          
          
          <td class="${changedClass(r,'etd')}">${fmtDateAR(r.etd)}</td>
          <td class="${changedClass(r,'eta')}">${fmtDateAR(r.eta)}</td>
          <td class="${changedClass(r,'notas')} notes-col">${rowNoteCell(r.notas)}</td>
          <td class="${changedClass(r,'puerto')}">${r.puerto || ''}</td>
          <td class="${changedClass(r,'terminal')}">${r.terminal || ''}</td>
          <td class="${changedClass(r,'deposito')}">${r.deposito || ''}</td>
          
          
          
          <td class="${changedClass(r,'estado')} estado-col">${estadoCell(r.estado)}</td>
          
          <td class="${changedClass(r,'documentos')}">${r.documentos ? `<a href="${r.documentos}" target="_blank" style="color:#0066cc;text-decoration:underline;">Abrir</a>` : ''}</td>
          <td>
            <button class="btn" data-action="edit" data-id="${r.id}" type="button">Editar</button>
            <button class="btn danger" data-action="del" data-id="${r.id}" type="button">Borrar</button>
          </td>
        </tr>`;
    }).join('');

    applyTitles(document.getElementById('tableGest'));

    gestBody.querySelectorAll('button[data-action]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = btn.getAttribute('data-id');
        const action = btn.getAttribute('data-action');
        const rec = data.find(x=>x.id===id);
        if(!rec) return;
        if(action === 'edit'){
          fillForm(rec);
          activateTab(0);
          setTimeout(()=>fields.nroEmbarque.focus(), 60);
        }else if(action === 'del'){
          if(confirm(`¬øBorrar embarque ${rec.nroEmbarque}?`)){
            data = data.filter(x=>x.id!==id);
            saveData();
            renderAll();
          }
        }
      });
    });
  }

  function renderPagos(){
    const q = $('searchPagos').value.trim().toLowerCase();
    const rows = data
      .filter(r => (r.estado||'').toLowerCase() !== 'cerrado')
      .filter(r=>{
        if(!q) return true;
        const hay = [r.nroEmbarque,r.importador,r.proveedor,r.condPago,r.moneda,r.estado].join(' ').toLowerCase();
        return hay.includes(q);
      })
      .sort((a,b)=>{
        const da = a.fechaSaldo ? new Date(a.fechaSaldo+"T00:00:00").getTime() : Number.POSITIVE_INFINITY;
        const db = b.fechaSaldo ? new Date(b.fechaSaldo+"T00:00:00").getTime() : Number.POSITIVE_INFINITY;
        if(da !== db) return da - db;
        const ea = a.eta ? new Date(a.eta+"T00:00:00").getTime() : Number.POSITIVE_INFINITY;
        const eb = b.eta ? new Date(b.eta+"T00:00:00").getTime() : Number.POSITIVE_INFINITY;
        return ea - eb;
      });

    pagosBody.innerHTML = rows.map(r=>{
      return `
        <tr>
          <td class="${changedClass(r,'nroEmbarque')}">${r.nroEmbarque || ''}</td>
          <td class="${changedClass(r,'estado')} estado-col">${estadoCell(r.estado)}</td>
          <td class="${changedClass(r,'importador')}">${r.importador || ''}</td>
          <td class="${changedClass(r,'proveedor')}">${r.proveedor || ''}</td>
          <td class="${changedClass(r,'tflag')} t-col">${r.tflag || ''}</td>
          <td class="notes-col">${rowNoteCell(r.notas)}</td>
          <td>${r.condPago || ''}</td>
          
          <td class="${changedClass(r,'eta')}">${fmtDateAR(r.eta)}</td>
          
          
          
          
          <td class="${changedClass(r,'moneda')}">${r.moneda || ''}</td>
          <td class="${changedClass(r,'factura')}">${fmtMoney.format(r.factura||0)}</td>
          <td class="${changedClass(r,'fechaAnticipo')}" >${fmtDateAR(r.fechaAnticipo)}</td>
          <td class="${changedClass(r,'anticipo')} ${r.chkAnticipo ? 'paid-amount' : ''}">${fmtMoney.format(r.anticipo||0)}</td>
          <td class="${changedClass(r,'fechaSaldo')} ${isPastDue(r.fechaSaldo) ? 'past-due' : ''}">${fmtDateAR(r.fechaSaldo)}</td>
          <td class="${changedClass(r,'saldo')} ${r.chkSaldo ? 'paid-amount' : ''}">${fmtMoney.format(r.saldo||0)}</td>
          <td class="${changedClass(r,'fechaAgencia')} ${isPastDue(r.fechaAgencia) ? 'past-due' : ''}">${fmtDateAR(r.fechaAgencia)}</td>
          <td class="${changedClass(r,'saldoAgencia')} ${r.chkAgencia ? 'paid-amount' : ''}">${fmtMoney.format(r.saldoAgencia||0)}</td>
          <td class="${changedClass(r,'fechaDespacho')} ${isPastDue(r.fechaDespacho) ? 'past-due' : ''}">${fmtDateAR(r.fechaDespacho)}</td>
          <td class="${changedClass(r,'pagoDespacho')} ${r.chkDespacho ? 'paid-amount' : ''}">${fmtMoney.format(r.pagoDespacho||0)}</td>
          <td class="${changedClass(r,'docFacturacion')}">${r.docFacturacion ? `<a href="${r.docFacturacion}" target="_blank" style="color:#0066cc;text-decoration:underline;">Abrir</a>` : ''}</td>
                    
        </tr>`;
    }).join('');

    applyTitles(document.getElementById('tablePagos'));

    renderCashflow(rows);
  }

  
  
  function renderCashflow(rows){
    const buckets = new Map(); // monthKey -> Map(moneda -> total)

    const now = new Date();
    const currentMonthKey = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;

    function addToBucket(dateIso, moneda, amount){
      if(!dateIso) return;
      if(!amount || Math.abs(amount) < 0.0000001) return;

      let mk = monthKey(dateIso);
      if(!mk) return;

      // Regla: todo lo vencido (meses anteriores) se acumula en el mes actual
      if(mk.localeCompare(currentMonthKey) < 0){
        mk = currentMonthKey;
      }

      if(!buckets.has(mk)) buckets.set(mk, new Map());
      const m = buckets.get(mk);
      m.set(moneda, (m.get(moneda)||0) + amount);
    }

    for(const r of rows){
      const moneda = r.moneda || '‚Äî';

      // Anticipo (si NO est√° tildado)
      if(!r.chkAnticipo){
        addToBucket(r.fechaAnticipo, moneda, (r.anticipo||0));
      }
      // Saldo (si NO est√° tildado)
      if(!r.chkSaldo){
        addToBucket(r.fechaSaldo, moneda, (r.saldo||0));
      }
      // Monto Agencia (si NO est√° tildado)
      if(!r.chkAgencia){
        addToBucket(r.fechaAgencia, moneda, (r.saldoAgencia||0));
      }
      // Monto Despacho (si NO est√° tildado)
      if(!r.chkDespacho){
        addToBucket(r.fechaDespacho, moneda, (r.pagoDespacho||0));
      }
    }

    const host = $('cashflowCards');
    if(buckets.size === 0){
      host.innerHTML = `<div class="card"><div class="date">Cash Flow</div><div class="mini">Sin montos pendientes (o sin fechas cargadas).</div></div>`;
      return;
    }

    // Siempre mostrar desde el mes actual hacia adelante (m√°x 4)
    const monthKeys = Array.from(buckets.keys()).sort((a,b)=>a.localeCompare(b));
    const filtered = monthKeys.filter(k => k.localeCompare(currentMonthKey) >= 0);
    const show = (filtered.length ? filtered : [currentMonthKey]).slice(0, 4);

    host.innerHTML = show.map(mk=>{
      const entries = Array.from((buckets.get(mk) || new Map()).entries())
        .filter(([_, total]) => Math.abs(total) > 0.0000001)
        .sort((a,b)=>String(a[0]).localeCompare(String(b[0])));

      const lines = entries.map(([moneda,total])=>`
        <div class="line"><span>${moneda}</span><span><b>${fmtMoney.format(total)}</b></span></div>
      `).join('');

      return `
        <div class="card">
          <div class="date">${monthLabelAR(mk)}</div>
          ${lines || '<div class="mini">Sin valores</div>'}
        </div>`;
    }).join('');
  }


  // ---------- Export CSV ----------
  function csvEscape(v){
    const s = (v ?? '').toString();
    if(/[",\n]/.test(s)) return '"' + s.replaceAll('"','""') + '"';
    return s;
  }
  function downloadCSV(filename, rows, headers){
    const lines = [];
    lines.push(headers.map(csvEscape).join(','));
    for(const r of rows){
      lines.push(headers.map(h=>csvEscape(r[h])).join(','));
    }
    const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  $('btnExportGest').addEventListener('click', ()=>{
    const rows = sortedGestion(data).map(r=>({
      "Nro Embarque": r.nroEmbarque,
      "Importador": r.importador,
      "Proveedor": r.proveedor,
      "T": r.tflag,
      "Carga": r.tipoCarga,
      "Nro Contenedor": r.nroContenedor,
                  "ETD": fmtDateAR(r.etd),
      "ETA": fmtDateAR(r.eta),
      "Notas": r.notas,
      "Puerto": r.puerto,
      "Terminal": r.terminal,
      "Dep√≥sito": r.deposito,
      "Estado": r.estado,
      "Doc": r.docFacturacion
    }));
    downloadCSV('gestion_embarques.csv', rows, Object.keys(rows[0]||{"Nro Embarque":""}));
  });

  $('btnExportPagos').addEventListener('click', ()=>{
    const rows = data
      .filter(r => (r.estado||'').toLowerCase() !== 'cerrado')
      .map(r=>{
        const deuda = ((r.factura||0) - (r.anticipo||0) - (r.saldo||0)) + (r.saldoAgencia||0) + (r.pagoDespacho||0);
        return {
          "Nro Embarque": r.nroEmbarque,
          "Estado": r.estado,
          "Importador": r.importador,
          "Proveedor": r.proveedor,
          "T": r.tflag,
          "Notas": r.notas,
          "Condici√≥n de Pago": r.condPago,
                    "ETA": fmtDateAR(r.eta),
          "Puerto": r.puerto,
          "Terminal": r.terminal,
          "Dep√≥sito": r.deposito,
                    "Moneda": r.moneda,
          "Factura": fmtMoney.format(r.factura||0),
          "Fecha Anticipo": fmtDateAR(r.fechaAnticipo),
          "Anticipo": fmtMoney.format(r.anticipo||0),
          "Fecha Saldo": fmtDateAR(r.fechaSaldo),
          "Saldo": fmtMoney.format(r.saldo||0),
          "Fecha Agencia": fmtDateAR(r.fechaAgencia),
          "Monto Agencia": fmtMoney.format(r.saldoAgencia||0),
          "Fecha Despacho": fmtDateAR(r.fechaDespacho),
          "Monto Despacho": fmtMoney.format(r.pagoDespacho||0),
          "Doc. Facturaci√≥n": r.docFacturacion,          "Doc": r.docFacturacion
        };
      });
    downloadCSV('plan_de_pagos.csv', rows, Object.keys(rows[0]||{"Nro Embarque":""}));
  });

  $('searchGest').addEventListener('input', renderGestion);
  $('searchPagos').addEventListener('input', renderPagos);

  // ---------- Init ----------
  function seedIfEmpty(){
    if(data.length) return;
    data.push({
      id: crypto.randomUUID(),
      estado: "En Camino",
      nroEmbarque: "M1230",
      importador: "Servitools",
      proveedor: "Hairun",
      tflag: "Si",
      tipoCarga: "40HQ",
      nroContenedor: "K-555-555",
      agencia: "Agencia 4",
      etd: "2025-04-01",
      eta: "2025-05-20",
      puerto: "Ningbo",
      terminal: "Terminal 4",
      deposito: "San Martin",
      condPago: "30% anticipo / 70% saldo",
      moneda: "USD",
      factura: 155000,
      fechaAnticipo: "2025-05-15",
      anticipo: 105000,
      fechaSaldo: "2026-01-01",
      saldo: 0,
      fechaAgencia: "",
      saldoAgencia: 0,
      fechaDespacho: "",
      pagoDespacho: 0,
      docFacturacion: "",
      notas: "Ejemplo de nota (hover sobre el globito).",
      documentos: "",
    });
    saveData();
  }

  function updateLastUpdateLabel(){
    const el = document.getElementById('lastUpdateLabel');
    if(!el) return;
    let maxIso = '';
    for(const r of data){
      if(r.updatedAt && (!maxIso || r.updatedAt > maxIso)) maxIso = r.updatedAt;
    }
    el.textContent = maxIso ? fmtDateTimeAR(maxIso) : '‚Äî';
  }

  const changedClass = (r, field) => {
    if(!r || !r.changes || !r.changes[field]) return '';
    return isWithinDays(r.changes[field], 7) ? 'recent-change' : '';
  };

  function renderAll(){
    renderGestion();
    renderPagos();
    updateLastUpdateLabel();
  }


  // ---------- Tooltip fijo para Notas (tipo Excel) ----------
  const noteTip = document.createElement('div');
  noteTip.className = 'note-tooltip-fixed';
  document.body.appendChild(noteTip);

  function showNoteTip(el){
    const html = el.getAttribute('data-note') || '';
    if(!html) return;
    noteTip.innerHTML = html;
    noteTip.style.display = 'block';
    positionNoteTip(el);
  }
  function hideNoteTip(){
    noteTip.style.display = 'none';
  }
  function positionNoteTip(el){
    const r = el.getBoundingClientRect();
    const pad = 10;
    // Por defecto a la derecha del √≠cono
    let left = r.right + 10;
    let top = r.top - 6;

    // Ajustes para que no salga de pantalla
    const tipRect = noteTip.getBoundingClientRect();
    const vw = window.innerWidth;
    const vh = window.innerHeight;

    if(left + tipRect.width + pad > vw){
      left = Math.max(pad, r.left - tipRect.width - 14);
      noteTip.style.setProperty('--arrow-left', 'auto');
    }
    if(top + tipRect.height + pad > vh){
      top = Math.max(pad, vh - tipRect.height - pad);
    }
    if(top < pad) top = pad;

    noteTip.style.left = left + 'px';
    noteTip.style.top = top + 'px';
  }

  // Delegaci√≥n de eventos para notas (funciona aunque se re-renderice la tabla)
  document.addEventListener('mouseover', (ev)=>{
    const el = ev.target.closest && ev.target.closest('.note-bubble[data-note]');
    if(!el) return;
    showNoteTip(el);
  });
  document.addEventListener('mouseout', (ev)=>{
    const el = ev.target.closest && ev.target.closest('.note-bubble[data-note]');
    if(!el) return;
    // Si salimos del icono, ocultar
    hideNoteTip();
  });
  window.addEventListener('scroll', hideNoteTip, true);
  window.addEventListener('resize', hideNoteTip);

  loadData().then(()=>{ renderAll(); });

  if(READ_ONLY){
    const tf = document.getElementById('tab-form');
    const pf = document.getElementById('panel-form');
    if(tf) tf.style.display='none';
    if(pf) pf.style.display='none';
    const bs = document.getElementById('btnSubmit');
    const br = document.getElementById('btnReset');
    if(bs) bs.disabled = true;
    if(br) br.disabled = true;
  }

  // ---------- Gate de acceso ----------
  // Intentar restaurar sesi√≥n; si no hay, mostrar login.
  const restored = tryRestoreAuth();
  if(!restored){
    setAllowedTabs([]); // ocultar todo hasta login
    showLogin();
  }else{
    hideLogin();
  }


// Editor simple de usuarios (admin)
const USERS_KEY='sia_users_simple';
function loadUsersSimple(){
  return JSON.parse(localStorage.getItem(USERS_KEY)||'{}');
}
function saveUsersSimple(u){localStorage.setItem(USERS_KEY,JSON.stringify(u));}

document.getElementById('btnOpenUsers')?.addEventListener('click',()=>{
  document.getElementById('usersOverlay').classList.add('show');
});
document.getElementById('uClose')?.addEventListener('click',()=>{
  document.getElementById('usersOverlay').classList.remove('show');
});
document.getElementById('uSave')?.addEventListener('click',()=>{
  const u=document.getElementById('uUser').value.trim();
  const p=document.getElementById('uPass').value.trim();
  if(!u||!p){document.getElementById('uHint').textContent='Completar usuario y contrase√±a';return;}
  const db=loadUsersSimple(); db[u]=p; saveUsersSimple(db);
  document.getElementById('uHint').textContent='Guardado';
});

</script>

  <!-- Admin: Editor de Usuarios (Seguro) -->
  <div id="usersOverlay" class="users-overlay" aria-hidden="true">
    <div class="users-card">
      <h3>Editor de usuarios</h3>
      <p class="mini">Esta versi√≥n inicial permite solo cambiar contrase√±as.</p>
      <div class="users-form-grid">
        <label>Usuario</label><input id="uUser" placeholder="admin / operaciones / consulta">
        <label>Nueva contrase√±a</label><input id="uPass" type="password">
      </div>
      <div class="users-actions">
        <button class="btn" id="uSave">Guardar</button>
        <button class="btn" id="uClose">Cerrar</button>
      </div>
      <div id="uHint" class="users-hint"></div>
    </div>
  </div>

</body>
</html>function toIsoFromAR(s){
    const t = (s||'').toString().trim();
    if(!t) return '';
    const m = t.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
    if(!m) return '';
    const dd = m[1].padStart(2,'0');
    const mm = m[2].padStart(2,'0');
    const yy = m[3];
    return `${yy}-${mm}-${dd}`;
  }

  
